#!/bin/bash
# Faster-whisper transcription with ECAPA-TDNN speaker embeddings
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"
VENV_DIR="$SCRIPT_DIR/venv-whisper"
PYTHON="$VENV_DIR/bin/python3"
PIP="$VENV_DIR/bin/pip"

# Auto-setup venv if missing
if [ ! -f "$PYTHON" ]; then
    echo "Setting up venv-whisper..."
    python3 -m venv "$VENV_DIR"
    "$PIP" install --upgrade pip
    "$PIP" install numpy torch torchaudio sounddevice pyyaml faster-whisper speechbrain
fi

# Source .env if present (set -a exports all variables)
if [ -f "$SCRIPT_DIR/.env" ]; then
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
fi

PYTHONPATH="$SCRIPT_DIR/src" exec "$PYTHON" -m transcribe_whisper "$@"
