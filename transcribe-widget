#!/bin/bash
# Menu bar widget for transcription control
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"
VENV_DIR="$SCRIPT_DIR/venv-m4"

# Auto-setup venv if missing (uses same venv as m4)
if [ ! -f "$VENV_DIR/bin/activate" ]; then
    echo "Setting up venv-m4..."
    python3 -m venv "$VENV_DIR"
    source "$VENV_DIR/bin/activate"
    pip install --upgrade pip
    pip install numpy torch torchaudio sounddevice pyyaml mlx-whisper pyannote.audio rumps pyobjc
else
    source "$VENV_DIR/bin/activate"
    # Check for widget-specific deps
    if ! python3 -c "import rumps" 2>/dev/null; then
        echo "Installing widget dependencies..."
        pip install rumps pyobjc
    fi
fi

# Source .env if present (set -a exports all variables)
if [ -f "$SCRIPT_DIR/.env" ]; then
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
fi

PYTHONPATH="$SCRIPT_DIR/src" python3 -m transcribe_widget "$@"
