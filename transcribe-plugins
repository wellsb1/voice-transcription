#!/bin/bash
# Plugin dispatcher - reads JSON lines, passes through to stdout, spawns plugins in background
# Each plugin receives the JSON array on stdin

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PLUGINS_DIR="$SCRIPT_DIR/plugins"

while IFS= read -r line; do
    # Pass through immediately
    echo "$line"

    # Spawn each executable plugin in background
    if [ -d "$PLUGINS_DIR" ]; then
        for plugin in "$PLUGINS_DIR"/*; do
            [ -x "$plugin" ] && [ -f "$plugin" ] && echo "$line" | "$plugin" 2>/dev/null &
        done
    fi
done
